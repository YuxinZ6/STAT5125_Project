---
title: "STAT5125_Project_Yuxin_Jen_Rene"
author: "Yuxin Zhang, Jennifer Nguyen, Rene Chang"
date: "2023-03-31"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Importing and Cleaning
## Set Up Environment
```{r environments and setup, message=FALSE}
# calling required packages
library(readr)
library(tidyverse)
library(tidymodels)
tidymodels_prefer()

setwd("~/Documents/Grad/Spring 2023/STAT_5125/course project /project/STAT5125_Project")
```

## Read in Data and Cleaning
### Cleaning Dataset 11_Direct_Investment-related_Indicators
```{r Cleaning dataset 11_Direct_Investment-related_Indicators}
####### Cleaning dataset 11_Direct_Investment-related_Indicators #######
# read the investment indicators dataset
investment_indicators <- read_csv("11_Direct_Investment-related_Indicators.csv")

# initial investigation in the dataset. 
investment_indicators %>% glimpse()
# subset the dataset to discard unwanted columns
investment_indicators <- investment_indicators %>% 
  select(Country, ISO2, ISO3, Indicator, Unit, `CTS Code`, `CTS Name`, Sector,
         `2005`:`2018`)
investment_indicators %>% glimpse()


# creating dictionary for the country with ISO2 and ISO3. 
Country_label <- investment_indicators %>% select(Country, ISO2, ISO3) %>% distinct()

# creating dictionary for the sectors.
Sectors_label <- investment_indicators %>% select(Sector) %>% distinct()
Sectors_label <- Sectors_label %>% 
  mutate(label = sapply(1:length(Sector), function(i) paste0("sector_", i)))

# creating dictionary for the 8 types of CO2 emissions. 
CTS_label <- investment_indicators %>% select(`CTS Code`, `CTS Name`) %>% distinct()

# creating dictionary for unit
unique(investment_indicators$Unit)
Unit_label <- matrix(c("Metric tons of CO2", "MT", 
                       "Metric tons of CO2 per million US$ of output", "MTPMDO",
                       "Metric tons per million US$", "MTPMD"), 
                     ncol = 2, byrow = TRUE) %>% as.data.frame()
colnames(Unit_label) <- c("Unit", "Unit_abb")


# match Units in dataset with its abbreviations, using the dictionary
# match Sectors in dataset with its abbreviations, using the dictionary
investment_indicators <- investment_indicators %>% 
  mutate(Unit_abb = sapply(Unit, 
                           function(x) Unit_label$Unit_abb[match(x, Unit_label$Unit)])) %>%
  relocate(Unit_abb, .before = Unit) %>% 
  mutate(Sector_abb = sapply(Sector, 
                             function(x) Sectors_label$label[match(x, Sectors_label$Sector)])) %>%
  relocate(Sector_abb, .before = Sector) %>% 
  glimpse()

# select the columns of interest, save it temporarily.
tmp <- investment_indicators %>% select(ISO3, `CTS Code`, Sector_abb, 
                                        `2005`:`2018`)
# pivot longer the year and pivot wider the indicators, save as emission_df
emission_df <- tmp %>% pivot_longer(cols = `2005`:`2018`,
                                    names_to = "Year",
                                    values_to = "CO2_emission") %>%
  pivot_wider(names_from = `CTS Code`,
              values_from = CO2_emission) %>% 
  select(-ECBIPF, -ECBIPD, -ECBIFR, -ECBIFF) %>% 
  mutate_all(~ ifelse(is.na(.), 0, .))

# Combining some sectors that have overlaps
emission_df <- emission_df %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_1", 
             "sector_14"),
             "Food", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_18", 
             "sector_42", "sector_43", "sector_44"),
             "Mining", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_2", 
             "sector_40"),
             "Agriculture", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_3", 
             "sector_37"),
             "Recreation", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_4", 
             "sector_12","sector_22", "sector_34"),
             "RawMaterial", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_5", 
             "sector_46","sector_38"),
             "Pharma", Sector_abb)) %>%  
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_6", 
             "sector_11", "sector_39", "sector_50"),
             "Energy", Sector_abb)) %>% 
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_7", 
             "sector_10", "sector_30"),
             "Electronic", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_8"),
             "Construction", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_9"),
             "Education", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_13",
             "sector_20", "sector_28", "sector_25", "sector_35",
             "sector_45", "sector_47", "sector_48", "sector_15",
             "sector_16", "sector_27", "sector_26"),
             "HumanActivities", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_17", 
             "sector_21"),
             "Machinery", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_19", 
             "sector_23", "sector_32", "sector_33", "sector_36",
             "sector_41", "sector_49", "sector_51"),
             "Transportation", Sector_abb)) %>%
  mutate(Sector_abb = if_else(Sector_abb %in% c("sector_24", 
             "sector_29", "sector_31"),
             "Manufacturing", Sector_abb)) %>%
  group_by(ISO3, Year, Sector_abb) %>%
  reframe(across(c(ECBIXD, ECBIXF, ECBIOD, ECBIOF), sum))
  

# remove data that will not be used again
rm(tmp, investment_indicators)



### Summary: all dictionaries have ending with "_label". 
### We will be using emission_df for further analysis. 
```

### Cleaning Dataset 24_Climate-related_Diasters_Frequency
```{r Cleaning dataset 24_Climate-related_Diasters_Frequency}
####### Cleaning dataset 24_Climate-related_Diasters_Frequency#######
disasters_frequency <- read_csv("24_Climate-related_Disasters_Frequency.csv")

# CTS Code for climate related disasters frequency is ECCD. 
# Adding ECCD to CTS_label dictionary. 
# Obtain the CTS code and name for disasters
ECCD_code <- disasters_frequency$`CTS Code` %>% unique()
ECCD_name <- disasters_frequency$`CTS Name` %>% unique()
# adding the CTS code and name for disasters to CTS dictionary
ECCD_df <- data.frame(ECCD_code, ECCD_name)
names(ECCD_df) <- c("CTS Code", "CTS Name")
CTS_label <- rbind(CTS_label, ECCD_df)


# Subset the dataset to discard unwanted data. 
# Narrow down the data to focus on years from 2005 to 2018 (range of years
# in the emission_df).
disasters_frequency <- disasters_frequency %>%
  select(ISO3, Indicator, `CTS Code`, `2005`:`2018`)

# mutate the Indicator column to trim away repeated information
disasters_frequency <- disasters_frequency %>% 
  mutate(Indicator_abb = 
           str_extract(Indicator, "(?<=: ).*")) %>%
  relocate(Indicator_abb, .after = Indicator) %>%
  select(-Indicator) %>%
  rename(Indicator = Indicator_abb)

# filter to only total count of disasters.
disasters_frequency <- disasters_frequency %>%
  filter(Indicator == "TOTAL") %>% 
  select(-Indicator)

# replace all na with zeros
disasters_frequency <- disasters_frequency %>%
  mutate_all(~replace_na(., 0)) %>% glimpse()

disasters_df <- disasters_frequency %>% 
  pivot_longer(cols = `2005`:`2018`, 
               names_to = "Year",
               values_to = "Count") %>%
  pivot_wider(names_from = `CTS Code`, 
              values_from = Count)



#######Combining the two data sets#######
df <- emission_df %>% left_join(disasters_df, by = c("ISO3", "Year"))
df %>% 
  mutate_at("Year", as.factor) %>%
  glimpse()

# remove data not going to be used
rm(ECCD_df, disasters_frequency)



#####More Manipulation to the Dataset#####
df <- df %>% relocate(Year, .before = Sector_abb)
# df <- df %>% mutate_all(~ ifelse(is.na(.), 0, .))
df <- df %>% rename(Export_Domestics = ECBIXD,
                           Export_Foreign = ECBIXF,
                           Output_Domestic = ECBIOD,
                           Output_Foreign = ECBIOF,
                           Disaster_Frequency = ECCD)


df_long <- df %>% pivot_longer(cols = Export_Domestics:Output_Foreign,
                           names_to = "Category",
                           values_to = "Value")
df_wide <- df_long %>% pivot_wider(names_from = c("Sector_abb", "Category"), 
                                   values_from = Value, 
                                   values_fill = 0,
                                   names_glue = "{Category}_{Sector_abb}")
# rm(df_long, df)
```

## Train Test Splitting
```{r Train Test Splitting}
set.seed(123457)
df_split <- df %>% initial_split(prop = 0.8)
train <- df_split %>% training()
test <- df_split %>% testing()
```

# Defining the Research Question
To examine the effects of domestically- versus foreign- controlled enterprises' CO2 emissions relative to sectors of activities performed for each country on climate related disasters. 
The models that we will approach are as the following:
- (Rene) Poisson Generalized Linear Regression Model with Lasso Penalty
  - Lasso Penalty will be determined through cross validation. 
- (Rene) Poisson Generalized Linear Model with Elastic Net Penalty
  - cross validation to determine the best penalty rate
- (Yuxin) Random Forest
  - pass along several possible combinations of hyper-parameters and perform cross validation
    - maximum depth, minimum number of samples at each split, n_estimators (4 for each)
    - parallel computing
- (Jen) K-Nearest Neighbors Regression
  - cross validation to determine the best k
- (Yuxin) XG-Boost
  - pass along several possible combinations of hyper-parameters and perform cross validation
  - maximum depth, minimum number of samples at each split, n_estimators (4 for each)
  - parallel computing
  
TARGET VARIABLE: Disaster_Frequency

graphics: 
- (Rene) line graph, count of disaster by year
  - color code by sector (t.s. plot)
- (Rene) line graph of aggregated count of disasters cross years. 
  - t.s. plot
- (Jen) world map and co2 emission (optional)
  - aggregating the co2 emission across all years, and rank by country.
  - ranking is going to be done by color. (gradient color, red is worse, while green is better)
- (Jen) co2 emission by country (do first, if time then do map)
- (Jen) bar graphs of *df_long* category column, x_axis is year. 
  - facet wrap by category
- (Yuxin) scatter plot, x-axis will be co2 emission, y-axis will be count of disasters. 
  - because count of disaster goes by year, then we will need to aggregate the co2 emission by country and by year. so we sum all of the sectors and types of co2 emissions. 

# Defining Workflow
```{r}
parsnip_1 <- linear_reg() %>%
  set_mode("regression") %>%
  set_engine("lm")
workflow_1 <- workflow() %>% 
  add_model(parsnip_1) %>%
  add_formula()
```


